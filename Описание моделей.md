# Документация по моделям системы

## Обзор

Система содержит следующие основные модели:

### 1. User (Пользователь)
**Файл:** `app/Models/User.php`

**Описание:** Основная модель для всех пользователей системы (Организаторы, Координаторы, Наставники, Участники).

**Поля:**
- `first_name`, `last_name`, `middle_name` - ФИО
- `email` - Email (уникальный)
- `phone` - Телефон
- `municipality_id` - Муниципальное образование
- `locality` - Населенный пункт
- `organization_id` - Образовательная организация
- `grade` - Класс (для участников)
- `team_id` - Команда (для участников)
- `position` - Должность (для координаторов и организаторов)
- `is_active` - Активен ли пользователь
- `marked_for_deletion` - Помечен на удаление
- `deletion_reason` - Причина удаления

**Связи:**
- `roles()` - Роли пользователя (many-to-many)
- `municipality()` - Муниципалитет (belongs-to)
- `organization()` - Организация (belongs-to)
- `team()` - Команда пользователя (belongs-to)
- `mentorTeams()` - Команды под руководством (has-many)
- `consentDocument()` - Согласие на ОПД (has-one)
- `news()` - Созданные новости (has-many)
- `events()` - Созданные события (has-many)
- `materials()` - Загруженные материалы (has-many)
- `reviews()` - Написанные отзывы (has-many)

**Методы:**
- `hasRole($roleName)` - Проверка наличия роли
- `hasAnyRole($roles)` - Проверка наличия любой из ролей
- `hasPermission($actionName)` - Проверка наличия разрешения
- `getFullNameAttribute()` - Получить полное имя

**Scopes:**
- `active()` - Активные пользователи
- `withRole($roleName)` - Пользователи с определенной ролью
- `participants()` - Участники
- `mentors()` - Наставники
- `coordinators()` - Координаторы
- `organizers()` - Организаторы

---

### 2. Role (Роль)
**Файл:** `app/Models/Role.php`

**Описание:** Роли пользователей в системе RBAC.

**Поля:**
- `name` - Название роли (уникальное)
- `guard_name` - Guard (по умолчанию 'web')

**Связи:**
- `users()` - Пользователи с этой ролью (many-to-many)
- `permissions()` - Разрешения роли (many-to-many)

**Методы:**
- `hasPermission($actionName)` - Проверка наличия разрешения

---

### 3. Permission (Разрешение)
**Файл:** `app/Models/Permission.php`

**Описание:** Разрешения для ролей в системе RBAC.

**Поля:**
- `action_name` - Название действия (уникальное)
- `description` - Описание разрешения

**Связи:**
- `roles()` - Роли с этим разрешением (many-to-many)

---

### 4. Municipality (Муниципалитет)
**Файл:** `app/Models/Municipality.php`

**Описание:** Муниципальные образования.

**Поля:**
- `name` - Название (уникальное)
- `region` - Регион

**Связи:**
- `organizations()` - Организации в муниципалитете (has-many)
- `teams()` - Команды из муниципалитета (has-many)
- `users()` - Пользователи из муниципалитета (has-many)
- `municipalStages()` - Муниципальные этапы (has-many)
- `events()` - События муниципалитета (has-many)

---

### 5. Organization (Организация)
**Файл:** `app/Models/Organization.php`

**Описание:** Образовательные организации.

**Поля:**
- `name` - Название
- `municipality_id` - Муниципалитет
- `locality` - Населенный пункт
- `address` - Адрес

**Связи:**
- `municipality()` - Муниципалитет (belongs-to)
- `teams()` - Команды организации (has-many)
- `users()` - Пользователи организации (has-many)

---

### 6. Team (Команда)
**Файл:** `app/Models/Team.php`

**Описание:** Команды участников турнира.

**Поля:**
- `name` - Название команды
- `organization_id` - Организация
- `municipality_id` - Муниципалитет
- `mentor_id` - Наставник
- `grade` - Класс
- `is_active` - Активна ли команда

**Связи:**
- `organization()` - Организация (belongs-to)
- `municipality()` - Муниципалитет (belongs-to)
- `mentor()` - Наставник (belongs-to User)
- `members()` - Участники команды (has-many User)
- `municipalStages()` - Муниципальные этапы (many-to-many)
- `regionalStages()` - Региональные этапы (many-to-many)

---

### 7. MunicipalStage (Муниципальный этап)
**Файл:** `app/Models/MunicipalStage.php`

**Описание:** Муниципальные этапы турнира.

**Поля:**
- `municipality_id` - Муниципалитет
- `event_date` - Дата проведения
- `event_time` - Время проведения
- `venue` - Место проведения
- `venue_address` - Адрес места
- `contact_info` - Контактная информация
- `status` - Статус (planned, ongoing, completed)
- `results` - Итоги

**Связи:**
- `municipality()` - Муниципалитет (belongs-to)
- `teams()` - Команды-участники (many-to-many)
- `reviews()` - Отзывы (morph-many)

**Scopes:**
- `completed()` - Завершенные этапы
- `ongoing()` - Текущие этапы
- `planned()` - Запланированные этапы

---

### 8. RegionalStage (Региональный этап)
**Файл:** `app/Models/RegionalStage.php`

**Описание:** Региональные этапы турнира.

**Поля:**
- `year` - Год проведения
- `event_date` - Дата проведения
- `event_time` - Время проведения
- `venue` - Место проведения
- `venue_address` - Адрес места
- `contact_info` - Контактная информация
- `status` - Статус (planned, ongoing, completed)
- `results` - Итоги

**Связи:**
- `teams()` - Команды-участники (many-to-many)
- `reviews()` - Отзывы (morph-many)

**Scopes:**
- `completed()` - Завершенные этапы
- `ongoing()` - Текущие этапы
- `planned()` - Запланированные этапы
- `forYear($year)` - Этапы определенного года

---

### 9. Event (Событие)
**Файл:** `app/Models/Event.php`

**Описание:** События в календаре.

**Поля:**
- `title` - Название
- `description` - Описание
- `start_date` - Дата начала
- `end_date` - Дата окончания
- `location` - Место проведения
- `type` - Тип (municipal_stage, regional_stage, meeting, deadline, other)
- `municipality_id` - Муниципалитет (опционально)
- `created_by` - Создатель

**Связи:**
- `municipality()` - Муниципалитет (belongs-to)
- `creator()` - Создатель (belongs-to User)

---

### 10. News (Новости)
**Файл:** `app/Models/News.php`

**Описание:** Новости турнира.

**Поля:**
- `title` - Заголовок
- `content` - Содержание
- `slug` - URL-slug (уникальный)
- `author_id` - Автор
- `is_published` - Опубликовано
- `published_at` - Дата публикации
- `image_path` - Путь к изображению

**Связи:**
- `author()` - Автор (belongs-to User)

**Scopes:**
- `published()` - Опубликованные новости

---

### 11. Material (Материалы)
**Файл:** `app/Models/Material.php`

**Описание:** Материалы для подготовки (задания, решения, видео).

**Поля:**
- `title` - Название
- `description` - Описание
- `type` - Тип (task, solution, video, other)
- `year` - Год
- `file_path` - Путь к файлу
- `video_url` - Ссылка на видео
- `uploaded_by` - Загрузивший
- `is_published` - Опубликовано

**Связи:**
- `uploader()` - Загрузивший (belongs-to User)

**Scopes:**
- `published()` - Опубликованные материалы
- `ofType($type)` - Материалы определенного типа
- `forYear($year)` - Материалы определенного года

---

### 12. Review (Отзыв)
**Файл:** `app/Models/Review.php`

**Описание:** Отзывы о муниципальных и региональных этапах.

**Поля:**
- `content` - Текст отзыва
- `author_id` - Автор
- `reviewable_type` - Тип объекта (полиморфная связь)
- `reviewable_id` - ID объекта (полиморфная связь)
- `is_approved` - Одобрен
- `is_published` - Опубликован

**Связи:**
- `author()` - Автор (belongs-to User)
- `reviewable()` - Объект отзыва (morph-to)

**Scopes:**
- `approved()` - Одобренные отзывы
- `published()` - Опубликованные отзывы

---

### 13. ConsentDocument (Согласие на ОПД)
**Файл:** `app/Models/ConsentDocument.php`

**Описание:** Документы согласия на обработку персональных данных.

**Поля:**
- `user_id` - Пользователь
- `file_path` - Путь к файлу
- `file_name` - Имя файла
- `uploaded_at` - Дата загрузки
- `is_verified` - Проверено

**Связи:**
- `user()` - Пользователь (belongs-to)

**Scopes:**
- `verified()` - Проверенные документы
- `unverified()` - Непроверенные документы

---

### 14. MunicipalStageTeam (Pivot-модель)
**Файл:** `app/Models/MunicipalStageTeam.php`

**Описание:** Связь команд и муниципальных этапов.

**Поля:**
- `municipal_stage_id` - Муниципальный этап
- `team_id` - Команда
- `score` - Баллы
- `rank` - Место
- `qualified_for_regional` - Прошла в региональный этап

---

### 15. RegionalStageTeam (Pivot-модель)
**Файл:** `app/Models/RegionalStageTeam.php`

**Описание:** Связь команд и региональных этапов.

**Поля:**
- `regional_stage_id` - Региональный этап
- `team_id` - Команда
- `score` - Баллы
- `rank` - Место

---

## Примеры использования

### Получить всех активных участников из определенного муниципалитета
```php
$participants = User::active()
    ->participants()
    ->where('municipality_id', $municipalityId)
    ->get();
```

### Получить команды, прошедшие в региональный этап
```php
$qualifiedTeams = Team::whereHas('municipalStages', function($query) {
    $query->where('municipal_stage_teams.qualified_for_regional', true);
})->get();
```

### Получить опубликованные отзывы о региональном этапе
```php
$reviews = $regionalStage->reviews()
    ->published()
    ->approved()
    ->with('author')
    ->get();
```

### Создать новость
```php
$news = News::create([
    'title' => 'Заголовок новости',
    'content' => 'Текст новости',
    'author_id' => auth()->id(),
    'is_published' => true,
    'published_at' => now(),
]);
```

### Проверить права пользователя
```php
if (auth()->user()->hasRole('organizer')) {
    // действия для организатора
}

if (auth()->user()->hasPermission('create_news')) {
    // разрешено создавать новости
}
```
